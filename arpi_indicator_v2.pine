//@version=5
indicator("Advanced Reversal Probability Indicator (ARPI) v2", overlay=false)

// ==================== 参数设定 ====================
group_rsi   = "RSI Settings"
group_macd  = "MACD Settings"
group_bb    = "Bollinger Bands"
group_vol   = "Volatility Filter"
group_div   = "Divergence Settings"
	rsi_length  = input.int(14, "RSI Period", group = group_rsi)
rsi_ob      = input.float(70.0, "RSI Overbought Level", group = group_rsi)
rsi_os      = input.float(30.0, "RSI Oversold Level", group = group_rsi)

macd_fast   = input.int(12, "MACD Fast Length", group = group_macd)
macd_slow   = input.int(26, "MACD Slow Length", group = group_macd)
macd_signal = input.int(9,  "MACD Signal Length", group = group_macd)

bb_length   = input.int(20,  "BB Period",    group = group_bb)
bb_std      = input.float(2, "BB StdDev",    group = group_bb)

atr_length        = input.int(14,  "ATR Period",                 group = group_vol)
min_vol_threshold = input.float(0.5, "Min ATR% for signal",      group = group_vol)
use_vol_filter    = input.bool(true, "Enable Volatility Filter", group = group_vol)

// 新增：冷卻參數，用來避免連續多根信號
cooldown_bars     = input.int(3, "Min bars between signals", minval = 1, group = "Signal Cooldown")

div_lookback      = input.int(5, "Divergence Lookback", group = group_div)

// ==================== 指標計算 ====================
rsi = ta.rsi(close, rsi_length)

[macd_line, macd_signal_line, macd_hist] = ta.macd(close, macd_fast, macd_slow, macd_signal)

bb_mid   = ta.sma(close, bb_length)
bb_dev   = ta.stdev(close, bb_length)
bb_upper = bb_mid + bb_std * bb_dev
bb_lower = bb_mid - bb_std * bb_dev

atr_val     = ta.atr(atr_length)
atr_percent = atr_val / close * 100.0

// ==================== 發散檢測 ====================
pl = ta.lowest(close, div_lookback)
ph = ta.highest(close, div_lookback)
rsiL = ta.lowest(rsi, div_lookback)
rsiH = ta.highest(rsi, div_lookback)
macdL = ta.lowest(macd_line, div_lookback)
macdH = ta.highest(macd_line, div_lookback)

bull_rsi_div  = close < pl and rsi > rsiL
bull_macd_div = close < pl and macd_line > macdL
bear_rsi_div  = close > ph and rsi < rsiH
bear_macd_div = close > ph and macd_line < macdH

// ==================== 波動篩選 ====================
sufficient_vol = not use_vol_filter or atr_percent > min_vol_threshold

// ==================== 反轉條件 ====================
rsi_oversold   = rsi < rsi_os
rsi_overbought = rsi > rsi_ob

price_below_bb = close < bb_lower
price_above_bb = close > bb_upper

near_lower_bb = close < (bb_mid + (bb_std * bb_dev * 0.0)) and not price_below_bb
near_upper_bb = close > (bb_mid + (bb_std * bb_dev * 0.6)) and not price_above_bb

bull_strong_cond = (bull_rsi_div or bull_macd_div or price_below_bb) and rsi_oversold
bull_mid_cond    = (near_lower_bb or bull_rsi_div or bull_macd_div) and rsi_oversold
bull_weak_cond   = rsi_oversold

bear_strong_cond = (bear_rsi_div or bear_macd_div or price_above_bb) and rsi_overbought
bear_mid_cond    = (near_upper_bb or bear_rsi_div or bear_macd_div) and rsi_overbought
bear_weak_cond   = rsi_overbought

// ==================== 信號強度計算（原始，未冷卻） ====================
raw_bull_strength = bull_strong_cond ? 100 : bull_mid_cond ? 66 : bull_weak_cond ? 33 : 0
raw_bear_strength = bear_strong_cond ? 100 : bear_mid_cond ? 66 : bear_weak_cond ? 33 : 0

// ==================== 冷卻邏輯：合併連續信號 ====================
var int last_bull_bar = na
var int last_bear_bar = na

new_bull_cluster = raw_bull_strength > 0 and (na(last_bull_bar) or bar_index - last_bull_bar > cooldown_bars)
new_bear_cluster = raw_bear_strength > 0 and (na(last_bear_bar) or bar_index - last_bear_bar > cooldown_bars)

if new_bull_cluster
    last_bull_bar := bar_index
if new_bear_cluster
    last_bear_bar := bar_index

// 只有在簇的第一根柱子上顯示信號，其餘連續柱子全部抑制
bull_strength = new_bull_cluster and sufficient_vol ? raw_bull_strength : 0
bear_strength = new_bear_cluster and sufficient_vol ? raw_bear_strength : 0

// ==================== 視覺化 ====================
plot(bull_strength,     title = "Bullish Strength (clustered)", color = color.new(color.lime, 0), style = plot.style_columns)
plot(-bear_strength,    title = "Bearish Strength (clustered)", color = color.new(color.red, 0),  style = plot.style_columns)
plot(atr_percent,       title = "ATR Volatility %",             color = color.new(color.blue, 0), linewidth = 2)
hline(min_vol_threshold, "Min ATR% Filter", color = color.gray, linestyle = hline.style_dashed)

bgcolor(bull_strength == 100 ? color.new(color.green, 85) : na, title = "Bullish BG")
bgcolor(bear_strength == 100 ? color.new(color.red, 85) : na,   title = "Bearish BG")

// ==================== 警報 ====================
alertcondition(bull_strength == 100, "Strong Bullish Reversal (clustered)", "Strong Bullish reversal (ARPI v2 clustered)")
alertcondition(bear_strength == 100, "Strong Bearish Reversal (clustered)", "Strong Bearish reversal (ARPI v2 clustered)")
